//@version=6
import TradingView/ta/8
strategy("EURUSD CVD + MACD EMA Combined Strategy", overlay=true, pyramiding=0, initial_capital=10000, default_qty_type=strategy.percent_of_equity, default_qty_value=100, max_labels_count=500)

// ═══════════════════════════════════════════════════════════════════════════
// COMBINED STRATEGY: EUR CVD Scanner + MACD + EMA Cross
// This script combines:
// 1. EUR CVD Scanner with session tracking, divergences, and trade management
// 2. MACD + EMA Cross indicator with Golden/Death Cross signals
// ═══════════════════════════════════════════════════════════════════════════

// ═══════════════════════════════════════════════════════════════════════════
// SESSION CONFIGURATION
// ═══════════════════════════════════════════════════════════════════════════

sessionGroup = "Session Settings"
asiaSession = input.session("1900-0100", "Asia Session", group=sessionGroup, tooltip="Define Asia trading session time range. Default: 7PM-1AM ET (typically 19:00-01:00). Use the time picker to adjust session times")
londonKZ = input.session("0300-0600", "London Kill Zone", group=sessionGroup, tooltip="Define London Kill Zone time range. Default: 3AM-6AM ET (typically 03:00-06:00). Use the time picker to adjust session times")
nyKZ = input.session("0900-1200", "New York Kill Zone", group=sessionGroup, tooltip="Define New York Kill Zone time range. Default: 9AM-12PM ET (typically 09:00-12:00). Use the time picker to adjust session times")
sessionTimezone = input.string("America/New_York", "Timezone", options=["America/New_York", "America/Chicago", "America/Los_Angeles", "Europe/London", "Europe/Paris", "Europe/Berlin", "Asia/Tokyo", "Asia/Shanghai", "Asia/Hong_Kong", "Asia/Singapore", "Australia/Sydney", "UTC"], group=sessionGroup, tooltip="Select timezone for session times. All sessions will be displayed relative to this timezone.")
showSessionBoxes = input.bool(true, "Show Session Boxes", group=sessionGroup, tooltip="Display colored boxes highlighting Asia, London, and NY Kill Zone sessions on the chart")
showAsiaLines = input.bool(true, "Show Asia Lines", group=sessionGroup, tooltip="Show Asia session high, low, and 50% lines that extend after the session ends")
showSessionRangePips = input.bool(true, "Show Session Range in Pips", group=sessionGroup, tooltip="Display Asia/London/NY session ranges in pips on the chart")
rangeLabelPosition = input.string("Bottom", "Range Label Position", options=["Top", "Bottom"], group=sessionGroup, tooltip="Position range labels at top or bottom of session range")
rangeLabelOffset = input.float(0.15, "Range Label Offset Multiplier", minval=0.0, maxval=1.0, step=0.05, group=sessionGroup, tooltip="Multiplier for ATR-based label offset. Higher values push labels further from box. Default 0.15 = 15% of ATR")
showADR = input.bool(true, "Show Average Daily Range (ADR)", group=sessionGroup, tooltip="Display ADR in pips alongside session ranges")
adrLength = input.int(21, "ADR Length (Days)", minval=1, maxval=100, group=sessionGroup, tooltip="Number of days to calculate average daily range (default: 21 = 3 weeks)")

// Support/Resistance Settings
supportResistanceGroup = "Support & Resistance Lines"
showPreviousDayHL = input.bool(true, "Show Previous Day High/Low (YH/YL)", group=supportResistanceGroup, tooltip="Display horizontal lines marking yesterday's high and low levels - key support/resistance zones")
previousDayColor = input.color(color.yellow, "Previous Day Line Color", group=supportResistanceGroup, tooltip="Customize the color of previous day high/low lines (default: yellow)")
previousDayWidth = input.int(1, "Previous Day Line Width", minval=1, maxval=5, group=supportResistanceGroup, tooltip="Set line thickness for previous day lines (1=thin, 5=thick)")
previousDayStyle = input.string("Dashed", "Previous Day Line Style", options=["Solid", "Dashed", "Dotted"], group=supportResistanceGroup, tooltip="Choose line style for previous day high/low")
showPreviousDayLabels = input.bool(true, "Show YH/YL Labels", group=supportResistanceGroup, tooltip="Display 'YH' (Yesterday High) and 'YL' (Yesterday Low) labels on the lines")

showCurrentWeekHL = input.bool(true, "Show Current Week High/Low (WH/WL)", group=supportResistanceGroup, tooltip="Display horizontal lines marking this week's current high and low levels")
currentWeekColor = input.color(color.new(color.olive, 0), "Current Week Line Color", group=supportResistanceGroup, tooltip="Customize the color of current week high/low lines (default: olive)")
currentWeekWidth = input.int(1, "Current Week Line Width", minval=1, maxval=5, group=supportResistanceGroup, tooltip="Set line thickness for current week lines (1=thin, 5=thick)")
currentWeekStyle = input.string("Dashed", "Current Week Line Style", options=["Solid", "Dashed", "Dotted"], group=supportResistanceGroup, tooltip="Choose line style for current week high/low")
showCurrentWeekLabels = input.bool(true, "Show WH/WL Labels", group=supportResistanceGroup, tooltip="Display 'WH' (Week High) and 'WL' (Week Low) labels on the lines")

showPreviousWeekHL = input.bool(true, "Show Previous Week High/Low (PWH/PWL)", group=supportResistanceGroup, tooltip="Display horizontal lines marking last week's high and low levels - important weekly support/resistance")
previousWeekColor = input.color(color.orange, "Previous Week Line Color", group=supportResistanceGroup, tooltip="Customize the color of previous week high/low lines (default: orange)")
previousWeekWidth = input.int(1, "Previous Week Line Width", minval=1, maxval=5, group=supportResistanceGroup, tooltip="Set line thickness for previous week lines (1=thin, 5=thick)")
previousWeekStyle = input.string("Dashed", "Previous Week Line Style", options=["Solid", "Dashed", "Dotted"], group=supportResistanceGroup, tooltip="Choose line style for previous week high/low")
showPreviousWeekLabels = input.bool(true, "Show PWH/PWL Labels", group=supportResistanceGroup, tooltip="Display 'PWH' (Previous Week High) and 'PWL' (Previous Week Low) labels on the lines")

// ═══════════════════════════════════════════════════════════════════════════
// CVD & DIVERGENCE SETTINGS
// ═══════════════════════════════════════════════════════════════════════════

cvdGroup = "CVD Settings"
showCVDPane = input.bool(true, "Show CVD Indicator Pane", group=cvdGroup, tooltip="Display Cumulative Volume Delta (CVD) in a separate pane below the main chart")
cvdAnchor = input.timeframe("1D", "CVD Anchor Period", group=cvdGroup, tooltip="Timeframe for CVD calculation reset. Daily (1D) resets CVD each day")
lowerTimeframeTooltip = "The indicator scans lower timeframe data to approximate up and down volume used in the delta calculation. By default, the timeframe is chosen automatically."
useCustomCVDTimeframe = input.bool(false, "Use Custom CVD Timeframe", tooltip=lowerTimeframeTooltip, group=cvdGroup)
lowerCVDTimeframe = input.timeframe("1", "CVD Timeframe", group=cvdGroup, tooltip="Specify custom timeframe for CVD calculation. Only used when 'Use Custom CVD Timeframe' is enabled")

divergenceDetectorGroup = "Divergence Detectors"
enableDivergence1 = input.bool(true, "Enable Divergence Detector 1 (Fast)", group=divergenceDetectorGroup, tooltip="Fast detector uses short pivot length for quicker divergence signals. Best for scalping and short-term trading")
pivotLength1 = input.int(2, "Pivot Length 1", minval=2, group=divergenceDetectorGroup, tooltip="Reduced from 5 to 2 for faster detection (60% faster). Checks 2 bars left + 2 bars right = 5 bar window.")
enableDivergence2 = input.bool(true, "Enable Divergence Detector 2 (Medium)", group=divergenceDetectorGroup, tooltip="Medium detector balances speed and reliability. Good for intraday trading")
pivotLength2 = input.int(6, "Pivot Length 2", minval=2, group=divergenceDetectorGroup, tooltip="Reduced from 10 to 6 for faster detection. Checks 6 bars left + 6 bars right = 13 bar window.")
enableDivergence3 = input.bool(false, "Enable Divergence Detector 3 (Slow)", group=divergenceDetectorGroup, tooltip="Slow detector uses longer pivot length for more reliable signals. Best for swing trading (disabled by default)")
pivotLength3 = input.int(10, "Pivot Length 3", minval=2, group=divergenceDetectorGroup, tooltip="Reduced from 15 to 10 for faster detection (33% faster). Checks 10 bars left + 10 bars right = 21 bar window.")
enableLiveDivergence = input.bool(true, "Enable Live Divergence Detection", group=divergenceDetectorGroup, tooltip="Show potential divergences in real-time without waiting for pivot confirmation. Purely visual - does not affect strategy entries.")
liveDivLookback = input.int(5, "Live Divergence Lookback", minval=5, maxval=100, group=divergenceDetectorGroup, tooltip="Number of bars to look back for CVD/price extremes in live divergence detection. Higher values catch more divergences but may produce more signals.")

// Live Divergence Display Settings
liveDivDisplayGroup = "Live Divergence Display"
liveDivBullColor = input.color(color.new(color.green, 30), "Live Divergence Bullish Color", group=liveDivDisplayGroup, tooltip="Color for live/unconfirmed bullish divergences (semi-transparent green by default)")
liveDivBearColor = input.color(color.new(color.red, 30), "Live Divergence Bearish Color", group=liveDivDisplayGroup, tooltip="Color for live/unconfirmed bearish divergences (semi-transparent red by default)")
liveDivLineStyle = input.string("Dotted", "Live Divergence Line Style", options=["Solid", "Dashed", "Dotted"], group=liveDivDisplayGroup, tooltip="Line style for live divergences. Dotted helps distinguish from confirmed divergences")
liveDivLineWidth = input.int(1, "Live Divergence Line Width", minval=1, maxval=5, group=liveDivDisplayGroup, tooltip="Line thickness for live divergences (1=thin, 5=thick). Thinner lines help differentiate from confirmed signals")

// Classic Divergence Settings
classicDivGroup = "Classic Divergence Settings"
showClassicDiv = input.bool(true, "Enable Classic Divergences", group=classicDivGroup, tooltip="Price higher high + CVD lower high OR price lower low + CVD higher low")
showClassicBullish = input.bool(true, "Enable Classic Bullish (Buy)", group=classicDivGroup, tooltip="Show bullish classic divergences (price makes lower low but CVD makes higher low)")
showClassicBearish = input.bool(true, "Enable Classic Bearish (Sell)", group=classicDivGroup, tooltip="Show bearish classic divergences (price makes higher high but CVD makes lower high)")
classicPivotLength = input.int(5, "Classic Pivot Length", minval=2, group=classicDivGroup, tooltip="Pivot confirmation period for classic divergences. Lower=faster but may have more false signals")
classicBullColor = input.color(color.green, "Classic Bullish Color", group=classicDivGroup, tooltip="Color for confirmed bullish classic divergence lines and labels")
classicBearColor = input.color(color.red, "Classic Bearish Color", group=classicDivGroup, tooltip="Color for confirmed bearish classic divergence lines and labels")
classicLineStyle = input.string("Dashed", "Classic Line Style", options=["Solid", "Dashed", "Dotted"], group=classicDivGroup, tooltip="Line style for classic divergences")
classicLineWidth = input.int(2, "Classic Line Width", minval=1, maxval=5, group=classicDivGroup, tooltip="Line thickness for classic divergences (1=thin, 5=thick)")
classicBullLabel = input.string("Classic Bull", "Classic Bullish Label", group=classicDivGroup, tooltip="Custom text for bullish classic divergence labels")
classicBearLabel = input.string("Classic Bear", "Classic Bearish Label", group=classicDivGroup, tooltip="Custom text for bearish classic divergence labels")

// Absorption Divergence Settings
absorptionDivGroup = "Absorption Divergence Settings"
showAbsorptionDiv = input.bool(true, "Enable Absorption Divergences", group=absorptionDivGroup, tooltip="Price new high/low but CVD doesn't - lack of participation")
showAbsorptionBullish = input.bool(true, "Enable Absorption Bullish (Buy)", group=absorptionDivGroup, tooltip="Show bullish absorption divergences (price makes new low but CVD doesn't follow)")
showAbsorptionBearish = input.bool(true, "Enable Absorption Bearish (Sell)", group=absorptionDivGroup, tooltip="Show bearish absorption divergences (price makes new high but CVD doesn't follow)")
absorptionPivotLength = input.int(5, "Absorption Pivot Length", minval=2, group=absorptionDivGroup, tooltip="Pivot confirmation period for absorption divergences")
absorptionBullColor = input.color(color.new(color.green, 30), "Absorption Bullish Color", group=absorptionDivGroup, tooltip="Color for bullish absorption divergence lines and labels")
absorptionBearColor = input.color(color.new(color.red, 30), "Absorption Bearish Color", group=absorptionDivGroup, tooltip="Color for bearish absorption divergence lines and labels")
absorptionLineStyle = input.string("Dotted", "Absorption Line Style", options=["Solid", "Dashed", "Dotted"], group=absorptionDivGroup, tooltip="Line style for absorption divergences")
absorptionLineWidth = input.int(2, "Absorption Line Width", minval=1, maxval=5, group=absorptionDivGroup, tooltip="Line thickness for absorption divergences (1=thin, 5=thick)")
absorptionBullLabel = input.string("Absorb Bull", "Absorption Bullish Label", group=absorptionDivGroup, tooltip="Custom text for bullish absorption divergence labels")
absorptionBearLabel = input.string("Absorb Bear", "Absorption Bearish Label", group=absorptionDivGroup, tooltip="Custom text for bearish absorption divergence labels")

// Exhaustion Divergence Settings
exhaustionDivGroup = "Exhaustion Divergence Settings"
showExhaustionDiv = input.bool(true, "Enable Exhaustion Divergences", group=exhaustionDivGroup, tooltip="CVD new high/low but price doesn't - volume/price imbalance")
showExhaustionBullish = input.bool(true, "Enable Exhaustion Bullish (Buy)", group=exhaustionDivGroup, tooltip="Show bullish exhaustion divergences (CVD makes new low but price doesn't)")
showExhaustionBearish = input.bool(true, "Enable Exhaustion Bearish (Sell)", group=exhaustionDivGroup, tooltip="Show bearish exhaustion divergences (CVD makes new high but price doesn't)")
exhaustionPivotLength = input.int(5, "Exhaustion Pivot Length", minval=2, group=exhaustionDivGroup, tooltip="Pivot confirmation period for exhaustion divergences")
exhaustionBullColor = input.color(color.new(color.green, 30), "Exhaustion Bullish Color", group=exhaustionDivGroup, tooltip="Color for bullish exhaustion divergence lines and labels")
exhaustionBearColor = input.color(color.new(color.red, 30), "Exhaustion Bearish Color", group=exhaustionDivGroup, tooltip="Color for bearish exhaustion divergence lines and labels")
exhaustionLineStyle = input.string("Dotted", "Exhaustion Line Style", options=["Solid", "Dashed", "Dotted"], group=exhaustionDivGroup, tooltip="Line style for exhaustion divergences")
exhaustionLineWidth = input.int(2, "Exhaustion Line Width", minval=1, maxval=5, group=exhaustionDivGroup, tooltip="Line thickness for exhaustion divergences (1=thin, 5=thick)")
exhaustionBullLabel = input.string("Exhaust Bull", "Exhaustion Bullish Label", group=exhaustionDivGroup, tooltip="Custom text for bullish exhaustion divergence labels")
exhaustionBearLabel = input.string("Exhaust Bear", "Exhaustion Bearish Label", group=exhaustionDivGroup, tooltip="Custom text for bearish exhaustion divergence labels")

// General Divergence Display
divDisplayGroup = "Divergence Display"
showDivergenceLabels = input.bool(false, "Show Divergence Labels", group=divDisplayGroup, tooltip="Display text labels on divergences (e.g., 'Classic Bull', 'Absorb Bear')")
showDivergenceLines = input.bool(true, "Show Divergence Lines", group=divDisplayGroup, tooltip="Display lines connecting the divergence pivot points")

// ═══════════════════════════════════════════════════════════════════════════
// TRADE MANAGEMENT SETTINGS
// ═══════════════════════════════════════════════════════════════════════════

tradeGroup = "Trade Management"
stopLossPips = input.float(5.0, "Stop Loss (Pips)", minval=0.1, step=0.1, group=tradeGroup, tooltip="Default stop loss distance in pips. Strategy calculates position size based on this and risk percent")
riskPercent = input.float(1.0, "Risk % of Equity", minval=0.1, step=0.1, group=tradeGroup, tooltip="Percentage of equity to risk per trade")
tp1Pips = input.float(10.0, "TP1 (Pips)", minval=1, step=1, group=tradeGroup)
enableTP2 = input.bool(false, "Enable TP2", group=tradeGroup)
tp2Pips = input.float(20.0, "TP2 (Pips)", minval=1, step=1, group=tradeGroup)
enableTP3 = input.bool(false, "Enable TP3", group=tradeGroup)
tp3Pips = input.float(30.0, "TP3 (Pips)", minval=1, step=1, group=tradeGroup)
tp1Percent = input.float(100.0, "TP1 Exit %", minval=1, maxval=100, group=tradeGroup)
tp2ExitPercent = input.float(25.0, "TP2 Exit %", minval=1, maxval=100, group=tradeGroup, tooltip="Percentage to exit at TP2 of remaining position after TP1")
moveToBreakevenAfterTP1 = input.bool(true, "Move to Breakeven after TP1", group=tradeGroup)
moveToBreakevenAfterTP2 = input.bool(false, "Move to Breakeven after TP2", group=tradeGroup)

// ═══════════════════════════════════════════════════════════════════════════
// ENTRY SIGNAL SETTINGS
// ═══════════════════════════════════════════════════════════════════════════

signalGroup = "Entry Signals"
useSignal1 = input.bool(false, "Enable Full Entry Signal", group=signalGroup, tooltip="Full entry requires all conditions: liquidity sweep, divergence, engulfing, kill zone, and day filter")
signal1Label = input.string("Full Entry", "Full Entry Label", group=signalGroup, tooltip="Custom label text for full entry signals on the chart")
signal1RequireLiqSweep = input.bool(true, "Require Liquidity Sweep", group=signalGroup, inline="full1", tooltip="Full entry must include Asia high/low liquidity sweep")
signal1RequireDivergence = input.bool(true, "Require Divergence", group=signalGroup, inline="full2", tooltip="Full entry must include price/CVD divergence")
signal1RequireEngulfing = input.bool(true, "Require Engulfing", group=signalGroup, inline="full3", tooltip="Full entry must include engulfing/pin bar candle pattern")
signal1RequireKillZone = input.bool(true, "Require Kill Zone", group=signalGroup, inline="full4", tooltip="Full entry must occur during London or NY kill zone")
signal1RequireDayFilter = input.bool(true, "Require Day Filter", group=signalGroup, inline="full5", tooltip="Full entry only on enabled trading days")

useSignal2 = input.bool(false, "Enable Simple Entry Signal", group=signalGroup, tooltip="Simple entry requires fewer conditions: divergence, engulfing, kill zone, and day filter (no liquidity sweep required)")
signal2Label = input.string("Simple Entry", "Simple Entry Label", group=signalGroup, tooltip="Custom label text for simple entry signals on the chart")
signal2RequireDivergence = input.bool(true, "Require Divergence", group=signalGroup, inline="simple1", tooltip="Simple entry must include price/CVD divergence")
signal2RequireEngulfing = input.bool(true, "Require Engulfing", group=signalGroup, inline="simple2", tooltip="Simple entry must include engulfing/pin bar candle pattern")
signal2RequireKillZone = input.bool(true, "Require Kill Zone", group=signalGroup, inline="simple3", tooltip="Simple entry must occur during London or NY kill zone")
signal2RequireDayFilter = input.bool(true, "Require Day Filter", group=signalGroup, inline="simple4", tooltip="Simple entry only on enabled trading days")

candleGroup = "Candle Pattern Selection"
candleMode = input.string("Engulfing Only", "Entry Candle Type", options=["Engulfing Only", "Pin Bar Only", "Both"], group=candleGroup, tooltip="Choose which candle patterns to use for entries: engulfing, pin bars, or both")
useBullishEngulfing = input.bool(true, "Use Bullish Engulfing", group=candleGroup, tooltip="Enable bullish engulfing patterns (bullish candle fully engulfs previous bearish candle)")
useBearishEngulfing = input.bool(true, "Use Bearish Engulfing", group=candleGroup, tooltip="Enable bearish engulfing patterns (bearish candle fully engulfs previous bullish candle)")
useBullishPinBar = input.bool(false, "Use Bullish Pin Bar", group=candleGroup, tooltip="Enable bullish pin bars (long lower wick, small body near high)")
useBearishPinBar = input.bool(false, "Use Bearish Pin Bar", group=candleGroup, tooltip="Enable bearish pin bars (long upper wick, small body near low)")

// Entry Candle Indicator Settings
candleIndicatorGroup = "Entry Candle Indicators"
showEngulfingIndicator = input.bool(true, "Show Engulfing Candles", group=candleIndicatorGroup, tooltip="Display labels on all engulfing candles found on the chart (not just entry signals)")
showPinBarIndicator = input.bool(false, "Show Pin Bars", group=candleIndicatorGroup, tooltip="Display labels on all pin bar candles found on the chart (not just entry signals)")
candleTimeFilter = input.string("All Times", "Show During", options=["All Times", "Kill Zones Only", "Custom Time Range"], group=candleIndicatorGroup, tooltip="Filter when to show candle pattern indicators")
candleCustomSession = input.session("0000-2359", "Custom Time Range", group=candleIndicatorGroup, tooltip="Custom time range for showing candle indicators. Only used when 'Show During' is set to 'Custom Time Range'. Use the time picker to adjust")

// Entry Candle Label Customization
labelTextGroup = "Entry Candle Label Text"
bullishEngulfingText = input.string("", "Bullish Engulfing Label", group=labelTextGroup, tooltip="Custom text for bullish engulfing candle labels")
bearishEngulfingText = input.string("", "Bearish Engulfing Label", group=labelTextGroup, tooltip="Custom text for bearish engulfing candle labels")
bullishPinBarText = input.string("", "Bullish Pin Bar Label", group=labelTextGroup, tooltip="Custom text for bullish pin bar candle labels")
bearishPinBarText = input.string("", "Bearish Pin Bar Label", group=labelTextGroup, tooltip="Custom text for bearish pin bar candle labels")

visualGroup = "Visual Settings"
showTradeLines = input.bool(true, "Show Trade Lines (Entry/SL/TP)", group=visualGroup, tooltip="Display horizontal lines showing entry price, stop loss, and take profit levels when trades are active")
maxLineHours = input.int(6, "Max Line Extension (Hours)", minval=1, maxval=24, group=visualGroup, tooltip="Maximum hours to extend trade lines after entry before they auto-delete")

// Line Style Settings
lineStyleGroup = "Line Style Settings"
asiaLineWidth = input.int(2, "Asia High/Low Lines Width", minval=1, maxval=5, group=lineStyleGroup, tooltip="Line thickness for Asia session high/low lines (1=thin, 5=thick)")
asiaLineStyle = input.string("Dashed", "Asia Line Style", options=["Solid", "Dashed", "Dotted"], group=lineStyleGroup, tooltip="Line style for Asia session high/low lines")
asiaLineColor = input.color(color.blue, "Asia Lines Color", group=lineStyleGroup, tooltip="Color for Asia session high/low/50% lines")
asiaMidLineWidth = input.int(1, "Asia 50% Line Width", minval=1, maxval=5, group=lineStyleGroup, tooltip="Line thickness for Asia session 50% midpoint line (1=thin, 5=thick)")
asiaMidLineColor = input.color(color.blue, "Asia 50% Line Color", group=lineStyleGroup, tooltip="Color for Asia session 50% midpoint line")
asiaLineExtensionHours = input.int(7, "Asia Lines Extension (Hours)", minval=1, maxval=24, tooltip="Number of hours to extend Asia high/low/50% lines from Asia session end", group=lineStyleGroup)
tradeLineWidth = input.int(2, "Trade Lines Width", minval=1, maxval=5, group=lineStyleGroup, tooltip="Line thickness for entry/stop loss/take profit lines (1=thin, 5=thick)")

// Kill Zone Settings - Trading Windows
kzGroup = "Kill Zone Trading Windows"
enableLondonKZ = input.bool(true, "Enable London Kill Zone", group=kzGroup, tooltip="Enable trading during London Kill Zone (typically 3AM-6AM ET when London market opens)")
londonKZSession = input.session("0200-0600", "London KZ Time Range", group=kzGroup, tooltip="Define London Kill Zone time range. Default: 2AM-6AM ET. Use the time picker to adjust session times")
enableNYKZ = input.bool(false, "Enable New York Kill Zone", group=kzGroup, tooltip="Enable trading during New York Kill Zone (typically 9AM-12PM ET when NY market opens)")
nyKZSession = input.session("0900-1200", "NY KZ Time Range", group=kzGroup, tooltip="Define New York Kill Zone time range. Default: 9AM-12PM ET. Use the time picker to adjust session times")

// Day Selection Settings
dayGroup = "Trading Days"
tradeMon = input.bool(true, "Monday", group=dayGroup, tooltip="Enable trading on Mondays")
tradeTue = input.bool(true, "Tuesday", group=dayGroup, tooltip="Enable trading on Tuesdays")
tradeWed = input.bool(true, "Wednesday", group=dayGroup, tooltip="Enable trading on Wednesdays")
tradeThu = input.bool(true, "Thursday", group=dayGroup, tooltip="Enable trading on Thursdays")
tradeFri = input.bool(true, "Friday", group=dayGroup, tooltip="Enable trading on Fridays")
tradeSat = input.bool(false, "Saturday", group=dayGroup, tooltip="Enable trading on Saturdays (typically low liquidity)")
tradeSun = input.bool(true, "Sunday", group=dayGroup, tooltip="Enable trading on Sundays")

// Additional Session Settings
additionalSessionGroup = "Additional Trading Sessions"
enableTokyo = input.bool(false, "Enable Tokyo Session", group=additionalSessionGroup, tooltip="Enable Tokyo session box display (typically midnight-9AM ET)")
tokyoSession = input.session("0000-0900", "Tokyo Session", group=additionalSessionGroup, tooltip="Define Tokyo session time range. Default: 12AM-9AM ET. Use the time picker to adjust session times")
enableSydney = input.bool(false, "Enable Sydney Session", group=additionalSessionGroup, tooltip="Enable Sydney session box display (typically 9PM-6AM ET)")
sydneySession = input.session("2100-0600", "Sydney Session", group=additionalSessionGroup, tooltip="Define Sydney session time range. Default: 9PM-6AM ET. Use the time picker to adjust session times")

// ═══════════════════════════════════════════════════════════════════════════
// MACD + EMA CROSS SETTINGS (Combined from MACD + EMA Cross indicator)
// ═══════════════════════════════════════════════════════════════════════════

macdEmaGroup = "MACD + EMA Cross Settings"
enableMacdEma = input.bool(true, "Enable MACD + EMA Cross", group=macdEmaGroup, tooltip="Enable the MACD + EMA Cross indicator overlay and signals")
showEmaLines = input.bool(true, "Show EMA Lines", group=macdEmaGroup, tooltip="Display EMA lines on chart (Momentum, Fast, Slow, Direction)")
showEmaCloud = input.bool(true, "Show EMA Cloud", group=macdEmaGroup, tooltip="Display cloud fill between Fast and Slow EMA")
showMacdEmaCross = input.bool(true, "Show EMA Cross Marker", group=macdEmaGroup, tooltip="Display cross marker when Fast EMA crosses Slow EMA")
showMacdEmaSignals = input.bool(true, "Show Buy/Sell Signals", group=macdEmaGroup, tooltip="Display B/S labels when Golden/Death Cross occurs with MACD confirmation")

// EMA Settings
emaSettingsGroup = "EMA Settings"
emaMomLength = input.int(8, "Momentum EMA Period", minval=1, group=emaSettingsGroup, tooltip="Period for Momentum EMA (default: 8)")
emaFastLength = input.int(20, "Fast EMA Period", minval=1, group=emaSettingsGroup, tooltip="Period for Fast EMA (default: 20)")
emaSlowLength = input.int(50, "Slow EMA Period", minval=1, group=emaSettingsGroup, tooltip="Period for Slow EMA (default: 50)")
emaDirLength = input.int(238, "Direction EMA Period", minval=1, group=emaSettingsGroup, tooltip="Period for Direction EMA (default: 238)")

// EMA Colors
emaColorsGroup = "EMA Colors"
emaMomColor = input.color(color.fuchsia, "Momentum EMA Color", group=emaColorsGroup)
emaFastColor = input.color(color.green, "Fast EMA Color", group=emaColorsGroup)
emaSlowColor = input.color(color.red, "Slow EMA Color", group=emaColorsGroup)
emaDirColor = input.color(color.blue, "Direction EMA Color", group=emaColorsGroup)
emaCloudBullColor = input.color(color.new(color.green, 80), "Bullish Cloud Color", group=emaColorsGroup)
emaCloudBearColor = input.color(color.new(color.red, 80), "Bearish Cloud Color", group=emaColorsGroup)

// MACD Settings
macdSettingsGroup = "MACD Settings"
macdFastLength = input.int(12, "MACD Fast Length", minval=1, group=macdSettingsGroup, tooltip="Fast EMA period for MACD calculation (default: 12)")
macdSlowLength = input.int(26, "MACD Slow Length", minval=1, group=macdSettingsGroup, tooltip="Slow EMA period for MACD calculation (default: 26)")
macdSignalLength = input.int(9, "MACD Signal Smoothing", minval=1, maxval=50, group=macdSettingsGroup, tooltip="Signal line smoothing period (default: 9)")

// MACD + EMA Entry Signal Settings
macdEmaSignalGroup = "MACD + EMA Entry Signal"
useSignal3 = input.bool(true, "Enable MACD + EMA Entry Signal", group=macdEmaSignalGroup, tooltip="Use MACD + EMA Golden/Death Cross as entry signal")
signal3Label = input.string("Entry", "Signal Label", group=macdEmaSignalGroup, tooltip="Custom label for MACD + EMA entry signals")
signal3RequireKillZone = input.bool(false, "Require Kill Zone", group=macdEmaSignalGroup, tooltip="MACD + EMA signal must occur during London or NY kill zone")
signal3RequireDayFilter = input.bool(true, "Require Day Filter", group=macdEmaSignalGroup, tooltip="MACD + EMA signal only on enabled trading days")

// ═══════════════════════════════════════════════════════════════════════════
// HELPER FUNCTIONS
// ═══════════════════════════════════════════════════════════════════════════

// Convert pips to price for EURUSD (1 pip = 0.0001)
pipsToPrice(pips) =>
    pips * 0.0001

// Convert line style string to constant
getLineStyle(styleStr) =>
    styleStr == "Solid" ? line.style_solid : styleStr == "Dashed" ? line.style_dashed : line.style_dotted

// Check if we're in a specific session
inSession(sessionSpec, tz) =>
    not na(time(timeframe.period, sessionSpec, tz))

// Get timeframe in minutes
getTimeframeMinutes() =>
    float tfMinutes = timeframe.multiplier * (timeframe.isseconds ? 1.0/60 : timeframe.isminutes ? 1.0 : timeframe.isdaily ? 1440.0 : timeframe.isweekly ? 10080.0 : timeframe.ismonthly ? 43200.0 : 1.0)
    tfMinutes

// Calculate max bars for line extension based on hours input
calcMaxBars(hours) =>
    int(math.round(hours * 60 / getTimeframeMinutes()))

// Check if current day is enabled for trading
isDayEnabled() =>
    dayOfWeek = dayofweek(time)
    (dayOfWeek == dayofweek.monday and tradeMon) or (dayOfWeek == dayofweek.tuesday and tradeTue) or (dayOfWeek == dayofweek.wednesday and tradeWed) or (dayOfWeek == dayofweek.thursday and tradeThu) or (dayOfWeek == dayofweek.friday and tradeFri) or (dayOfWeek == dayofweek.saturday and tradeSat) or (dayOfWeek == dayofweek.sunday and tradeSun)

// Check if we're in London Kill Zone
isInLondonKZ() =>
    enableLondonKZ and inSession(londonKZSession, sessionTimezone)

// Check if we're in New York Kill Zone
isInNYKZ() =>
    enableNYKZ and inSession(nyKZSession, sessionTimezone)

// Get most recent non-na value from three detectors (for live divergence)
// Returns val1 if not na, otherwise val2 if not na, otherwise val3
// Used to find the most recent confirmed pivot from multiple detectors
getMostRecentValue(val1, val2, val3) =>
    not na(val1) ? val1 : not na(val2) ? val2 : val3

// Convert price range to pips (for EURUSD and other forex pairs)
// For EURUSD: 1 pip = 0.0001, so we divide by mintick and then by 10
priceToPips(priceRange) =>
    priceRange / syminfo.mintick / 10

// Calculate Average Daily Range
calcADR(length) =>
    dailyRange = request.security(syminfo.tickerid, 'D', high - low, lookahead=barmerge.lookahead_on)
    ta.sma(dailyRange, length)

// ═══════════════════════════════════════════════════════════════════════════
// SESSION DETECTION
// ═══════════════════════════════════════════════════════════════════════════

isAsiaSession = inSession(asiaSession, sessionTimezone)
isLondonKZ = inSession(londonKZ, sessionTimezone)
isNYKZ = inSession(nyKZ, sessionTimezone)
isTokyoSession = enableTokyo and inSession(tokyoSession, sessionTimezone)
isSydneySession = enableSydney and inSession(sydneySession, sessionTimezone)

// Kill Zone windows for trading (using custom hour settings)
isLondonKZWindow = isInLondonKZ()
isNYKZWindow = isInNYKZ()

// Combined session check for additional sessions
isInAdditionalSession = isTokyoSession or isSydneySession

// Detect session transitions
var bool wasAsiaSession = false
var bool wasLondonKZ = false
var bool wasNYKZ = false

asiaSessionEnded = wasAsiaSession and not isAsiaSession
londonKZEnded = wasLondonKZ and not isLondonKZ
nyKZEnded = wasNYKZ and not isNYKZ

asiaSessionStarted = not wasAsiaSession and isAsiaSession
londonKZStarted = not wasLondonKZ and isLondonKZ
nyKZStarted = not wasNYKZ and isNYKZ

wasAsiaSession := isAsiaSession
wasLondonKZ := isLondonKZ
wasNYKZ := isNYKZ

// ═══════════════════════════════════════════════════════════════════════════
// SESSION HIGH/LOW TRACKING
// ═══════════════════════════════════════════════════════════════════════════

// Asia Session
var float asiaHigh = na
var float asiaLow = na
var int asiaStartBar = na
var int asiaEndBar = na

if asiaSessionStarted
    asiaHigh := high
    asiaLow := low
    asiaStartBar := bar_index

if isAsiaSession
    asiaHigh := math.max(asiaHigh, high)
    asiaLow := math.min(asiaLow, low)

if asiaSessionEnded
    asiaEndBar := bar_index - 1

// London Kill Zone
var float londonHigh = na
var float londonLow = na
var int londonStartBar = na
var int londonEndBar = na

if londonKZStarted
    londonHigh := high
    londonLow := low
    londonStartBar := bar_index

if isLondonKZ
    londonHigh := math.max(londonHigh, high)
    londonLow := math.min(londonLow, low)

if londonKZEnded
    londonEndBar := bar_index - 1

// New York Kill Zone
var float nyHigh = na
var float nyLow = na
var int nyStartBar = na
var int nyEndBar = na

if nyKZStarted
    nyHigh := high
    nyLow := low
    nyStartBar := bar_index

if isNYKZ
    nyHigh := math.max(nyHigh, high)
    nyLow := math.min(nyLow, low)

if nyKZEnded
    nyEndBar := bar_index - 1

// ═══════════════════════════════════════════════════════════════════════════
// SESSION BOXES (LIVE UPDATING DURING SESSION)
// ═══════════════════════════════════════════════════════════════════════════

// Track active session boxes that update live
var box asiaBox = na
var box londonBox = na
var box nyBox = na

if showSessionBoxes
    // Asia Session Box - Create on session start, update during session
    if asiaSessionStarted and not na(asiaStartBar)
        // Delete old box if it exists
        if not na(asiaBox)
            box.delete(asiaBox)
        // Create new box at session start
        asiaBox := box.new(asiaStartBar, asiaHigh, bar_index, asiaLow, border_color=color.new(color.blue, 70), bgcolor=color.new(color.blue, 90), border_width=1)
    
    // Update Asia box during session
    if isAsiaSession and not na(asiaBox)
        box.set_right(asiaBox, bar_index)
        box.set_top(asiaBox, asiaHigh)
        box.set_bottom(asiaBox, asiaLow)
    
    // Finalize Asia box when session ends
    if asiaSessionEnded and not na(asiaBox) and not na(asiaEndBar)
        box.set_right(asiaBox, asiaEndBar)
        asiaBox := na  // Clear reference so next session creates new box
    
    // London Kill Zone Box - Create on session start, update during session
    if londonKZStarted and not na(londonStartBar)
        // Delete old box if it exists
        if not na(londonBox)
            box.delete(londonBox)
        // Create new box at session start
        londonBox := box.new(londonStartBar, londonHigh, bar_index, londonLow, border_color=color.new(color.orange, 70), bgcolor=color.new(color.orange, 90), border_width=1)
    
    // Update London box during session
    if isLondonKZ and not na(londonBox)
        box.set_right(londonBox, bar_index)
        box.set_top(londonBox, londonHigh)
        box.set_bottom(londonBox, londonLow)
    
    // Finalize London box when session ends
    if londonKZEnded and not na(londonBox) and not na(londonEndBar)
        box.set_right(londonBox, londonEndBar)
        londonBox := na  // Clear reference so next session creates new box
    
    // New York Kill Zone Box - Create on session start, update during session
    if nyKZStarted and not na(nyStartBar)
        // Delete old box if it exists
        if not na(nyBox)
            box.delete(nyBox)
        // Create new box at session start
        nyBox := box.new(nyStartBar, nyHigh, bar_index, nyLow, border_color=color.new(color.green, 70), bgcolor=color.new(color.green, 90), border_width=1)
    
    // Update NY box during session
    if isNYKZ and not na(nyBox)
        box.set_right(nyBox, bar_index)
        box.set_top(nyBox, nyHigh)
        box.set_bottom(nyBox, nyLow)
    
    // Finalize NY box when session ends
    if nyKZEnded and not na(nyBox) and not na(nyEndBar)
        box.set_right(nyBox, nyEndBar)
        nyBox := na  // Clear reference so next session creates new box

// ═══════════════════════════════════════════════════════════════════════════
// SESSION RANGE IN PIPS & ADR DISPLAY
// ═══════════════════════════════════════════════════════════════════════════

// Calculate ADR if enabled
var float currentADR = na
if showADR
    currentADR := calcADR(adrLength)

// Display Asia session range in pips when session ends
if showSessionRangePips and asiaSessionEnded and not na(asiaHigh) and not na(asiaLow) and not na(asiaStartBar) and not na(asiaEndBar)
    asiaRangePips = priceToPips(asiaHigh - asiaLow)
    // Calculate midpoint bar for centered label
    asiaMidBar = math.round((asiaStartBar + asiaEndBar) / 2)
    // Simple text format: "A = X.X" or "A = X.X\nADR = Y.Y" with 1 decimal place
    labelText = showADR and not na(currentADR) ? "A = " + str.tostring(asiaRangePips, "#.#") + "\nADR = " + str.tostring(priceToPips(currentADR), "#.#") : "A = " + str.tostring(asiaRangePips, "#.#")
    // Offset label outside the box using user-configurable multiplier
    atr = ta.atr(14)
    labelOffset = atr * rangeLabelOffset
    labelY = rangeLabelPosition == "Bottom" ? asiaLow - labelOffset : asiaHigh + labelOffset
    // Use yloc.price to position below/above the box border
    label.new(asiaMidBar, labelY, labelText, xloc=xloc.bar_index, yloc=yloc.price, color=color.new(color.black, 100), textcolor=color.blue, size=size.small, style=label.style_none)

// Display London session range in pips when session ends
if showSessionRangePips and londonKZEnded and not na(londonHigh) and not na(londonLow) and not na(londonStartBar) and not na(londonEndBar)
    londonRangePips = priceToPips(londonHigh - londonLow)
    // Calculate midpoint bar for centered label
    londonMidBar = math.round((londonStartBar + londonEndBar) / 2)
    // Simple text format: "L = X.X" or "L = X.X\nADR = Y.Y" with 1 decimal place
    labelText = showADR and not na(currentADR) ? "L = " + str.tostring(londonRangePips, "#.#") + "\nADR = " + str.tostring(priceToPips(currentADR), "#.#") : "L = " + str.tostring(londonRangePips, "#.#")
    // Offset label outside the box using user-configurable multiplier
    atr = ta.atr(14)
    labelOffset = atr * rangeLabelOffset
    labelY = rangeLabelPosition == "Bottom" ? londonLow - labelOffset : londonHigh + labelOffset
    // Use yloc.price to position below/above the box border
    label.new(londonMidBar, labelY, labelText, xloc=xloc.bar_index, yloc=yloc.price, color=color.new(color.black, 100), textcolor=color.orange, size=size.small, style=label.style_none)

// Display NY session range in pips when session ends
if showSessionRangePips and nyKZEnded and not na(nyHigh) and not na(nyLow) and not na(nyStartBar) and not na(nyEndBar)
    nyRangePips = priceToPips(nyHigh - nyLow)
    // Calculate midpoint bar for centered label
    nyMidBar = math.round((nyStartBar + nyEndBar) / 2)
    // Simple text format: "NY = X.X" or "NY = X.X\nADR = Y.Y" with 1 decimal place
    labelText = showADR and not na(currentADR) ? "NY = " + str.tostring(nyRangePips, "#.#") + "\nADR = " + str.tostring(priceToPips(currentADR), "#.#") : "NY = " + str.tostring(nyRangePips, "#.#")
    // Offset label outside the box using user-configurable multiplier
    atr = ta.atr(14)
    labelOffset = atr * rangeLabelOffset
    labelY = rangeLabelPosition == "Bottom" ? nyLow - labelOffset : nyHigh + labelOffset
    // Use yloc.price to position below/above the box border
    label.new(nyMidBar, labelY, labelText, xloc=xloc.bar_index, yloc=yloc.price, color=color.new(color.black, 100), textcolor=color.green, size=size.small, style=label.style_none)

// ═══════════════════════════════════════════════════════════════════════════
// SUPPORT & RESISTANCE LINES (PREVIOUS DAY/WEEK HIGH/LOW)
// ═══════════════════════════════════════════════════════════════════════════

// Helper function to get previous day/week data
getData(resolution, source) =>
    request.security(syminfo.tickerid, resolution, source, lookahead=barmerge.lookahead_on)

// Get previous day high/low
previousDayHigh = getData('D', high[1])
previousDayLow = getData('D', low[1])

// Get current week high/low
currentWeekHigh = getData('W', high[0])
currentWeekLow = getData('W', low[0])

// Get previous week high/low
previousWeekHigh = getData('W', high[1])
previousWeekLow = getData('W', low[1])

// Convert line style strings
srLineStyle(style) =>
    style == "Solid" ? line.style_solid : style == "Dashed" ? line.style_dashed : line.style_dotted

// Track if it's a new day for label updates
var int lastDay = na
var int lastMonth = na
var int lastYear = na
currentDay = dayofmonth(time)
currentMonth = month(time)
currentYear = year(time)
isNewDay = (currentDay != lastDay) or (currentMonth != lastMonth) or (currentYear != lastYear)
if isNewDay
    lastDay := currentDay
    lastMonth := currentMonth
    lastYear := currentYear

// Previous Day High/Low Lines
var line pdHighLine = na
var line pdLowLine = na
var label pdHighLabel = na
var label pdLowLabel = na

if showPreviousDayHL
    // Delete old lines and labels
    if not na(pdHighLine)
        line.delete(pdHighLine)
    if not na(pdLowLine)
        line.delete(pdLowLine)
    if not na(pdHighLabel)
        label.delete(pdHighLabel)
    if not na(pdLowLabel)
        label.delete(pdLowLabel)
    
    // Draw new lines
    pdHighLine := line.new(bar_index - 50, previousDayHigh, bar_index + 10, previousDayHigh, xloc=xloc.bar_index, color=previousDayColor, style=srLineStyle(previousDayStyle), width=previousDayWidth)
    pdLowLine := line.new(bar_index - 50, previousDayLow, bar_index + 10, previousDayLow, xloc=xloc.bar_index, color=previousDayColor, style=srLineStyle(previousDayStyle), width=previousDayWidth)
    
    // Add labels if enabled (show every bar for visibility)
    if showPreviousDayLabels
        pdHighLabel := label.new(bar_index, previousDayHigh, "YH", xloc=xloc.bar_index, yloc=yloc.price, color=color.new(color.black, 100), style=label.style_none, textcolor=previousDayColor, size=size.small)
        pdLowLabel := label.new(bar_index, previousDayLow, "YL", xloc=xloc.bar_index, yloc=yloc.price, color=color.new(color.black, 100), style=label.style_none, textcolor=previousDayColor, size=size.small)

// Current Week High/Low Lines
var line cwHighLine = na
var line cwLowLine = na
var label cwHighLabel = na
var label cwLowLabel = na

if showCurrentWeekHL
    // Delete old lines and labels
    if not na(cwHighLine)
        line.delete(cwHighLine)
    if not na(cwLowLine)
        line.delete(cwLowLine)
    if not na(cwHighLabel)
        label.delete(cwHighLabel)
    if not na(cwLowLabel)
        label.delete(cwLowLabel)
    
    // Draw new lines
    cwHighLine := line.new(bar_index - 100, currentWeekHigh, bar_index + 10, currentWeekHigh, xloc=xloc.bar_index, color=currentWeekColor, style=srLineStyle(currentWeekStyle), width=currentWeekWidth)
    cwLowLine := line.new(bar_index - 100, currentWeekLow, bar_index + 10, currentWeekLow, xloc=xloc.bar_index, color=currentWeekColor, style=srLineStyle(currentWeekStyle), width=currentWeekWidth)
    
    // Add labels if enabled (show every bar for visibility)
    if showCurrentWeekLabels
        cwHighLabel := label.new(bar_index, currentWeekHigh, "WH", xloc=xloc.bar_index, yloc=yloc.price, color=color.new(color.black, 100), style=label.style_none, textcolor=currentWeekColor, size=size.small)
        cwLowLabel := label.new(bar_index, currentWeekLow, "WL", xloc=xloc.bar_index, yloc=yloc.price, color=color.new(color.black, 100), style=label.style_none, textcolor=currentWeekColor, size=size.small)

// Previous Week High/Low Lines
var line pwHighLine = na
var line pwLowLine = na
var label pwHighLabel = na
var label pwLowLabel = na

if showPreviousWeekHL
    // Delete old lines and labels
    if not na(pwHighLine)
        line.delete(pwHighLine)
    if not na(pwLowLine)
        line.delete(pwLowLine)
    if not na(pwHighLabel)
        label.delete(pwHighLabel)
    if not na(pwLowLabel)
        label.delete(pwLowLabel)
    
    // Draw new lines
    pwHighLine := line.new(bar_index - 100, previousWeekHigh, bar_index + 10, previousWeekHigh, xloc=xloc.bar_index, color=previousWeekColor, style=srLineStyle(previousWeekStyle), width=previousWeekWidth)
    pwLowLine := line.new(bar_index - 100, previousWeekLow, bar_index + 10, previousWeekLow, xloc=xloc.bar_index, color=previousWeekColor, style=srLineStyle(previousWeekStyle), width=previousWeekWidth)
    
    // Add labels if enabled (show every bar for visibility)
    if showPreviousWeekLabels
        pwHighLabel := label.new(bar_index, previousWeekHigh, "PWH", xloc=xloc.bar_index, yloc=yloc.price, color=color.new(color.black, 100), style=label.style_none, textcolor=previousWeekColor, size=size.small)
        pwLowLabel := label.new(bar_index, previousWeekLow, "PWL", xloc=xloc.bar_index, yloc=yloc.price, color=color.new(color.black, 100), style=label.style_none, textcolor=previousWeekColor, size=size.small)

// ═══════════════════════════════════════════════════════════════════════════
// ASIA SESSION LINES (ANCHORED, AUTO-DELETE AT LONDON KZ END)
// ═══════════════════════════════════════════════════════════════════════════

var line asiaHighLine = na
var line asiaLowLine = na
var line asiaMidLine = na
var int asiaLineStartBar = na
var int asiaLineMaxBar = na

// Calculate max bars for Asia line extension
asiaLineMaxBars = calcMaxBars(asiaLineExtensionHours)

if showAsiaLines
    // Create lines at Asia session end (persistent on historical data)
    if asiaSessionEnded and not na(asiaHigh) and not na(asiaLow)
        // Store start bar for lines and calculate max end bar
        asiaLineStartBar := bar_index
        asiaLineMaxBar := bar_index + asiaLineMaxBars
        
        // Get line style from user input
        asiaStyle = getLineStyle(asiaLineStyle)
        
        // Create new lines from current bar (will be extended up to max hours)
        // Don't delete old lines - let them persist on historical data
        asiaHighLine := line.new(bar_index, asiaHigh, bar_index, asiaHigh, color=asiaLineColor, style=asiaStyle, width=asiaLineWidth)
        asiaLowLine := line.new(bar_index, asiaLow, bar_index, asiaLow, color=asiaLineColor, style=asiaStyle, width=asiaLineWidth)
        asiaMidLine := line.new(bar_index, (asiaHigh + asiaLow) / 2, bar_index, (asiaHigh + asiaLow) / 2, color=asiaMidLineColor, style=line.style_dotted, width=asiaMidLineWidth)
    
    // Extend lines each bar until max hours reached
    if not na(asiaHighLine) and not na(asiaLineStartBar) and not na(asiaLineMaxBar)
        if bar_index <= asiaLineMaxBar
            line.set_x2(asiaHighLine, bar_index)
            line.set_x2(asiaLowLine, bar_index)
            line.set_x2(asiaMidLine, bar_index)

// ═══════════════════════════════════════════════════════════════════════════
// CVD CALCULATION (TradingView Official Method)
// ═══════════════════════════════════════════════════════════════════════════

// Determine lower timeframe for CVD calculation
lowerTimeframe = switch
    useCustomCVDTimeframe => lowerCVDTimeframe
    timeframe.isseconds   => "1S"
    timeframe.isintraday  => "1"
    timeframe.isdaily     => "5"
    => "60"

// Use TradingView's official requestVolumeDelta function
[openVolume, maxVolume, minVolume, lastVolume] = ta.requestVolumeDelta(lowerTimeframe, cvdAnchor)

// Use lastVolume as CVD
cvd = lastVolume

// Volume check
var cumVol = 0.0
cumVol += nz(volume)
if barstate.islast and cumVol == 0
    runtime.error("The data vendor doesn't provide volume data for this symbol.")

// ═══════════════════════════════════════════════════════════════════════════
// MACD + EMA CALCULATIONS
// ═══════════════════════════════════════════════════════════════════════════

// EMA Calculations
emaMom = ta.ema(close, emaMomLength)
emaFast = ta.ema(close, emaFastLength)
emaSlow = ta.ema(close, emaSlowLength)
emaDirection = ta.ema(close, emaDirLength)

// EMA Cross Detection - Directional crosses
emaCrossOver = ta.crossover(emaFast, emaSlow)   // Fast crosses above Slow (bullish)
emaCrossUnder = ta.crossunder(emaFast, emaSlow) // Fast crosses below Slow (bearish)
emaCross = emaCrossOver or emaCrossUnder        // Any cross (for visual marker)

// MACD Calculations
macdFastMa = ta.ema(close, macdFastLength)
macdSlowMa = ta.ema(close, macdSlowLength)
macdLine = macdFastMa - macdSlowMa
macdSignalLine = ta.ema(macdLine, macdSignalLength)
macdHist = macdLine - macdSignalLine

// Golden/Death Cross with MACD Confirmation
// Golden Cross: Fast EMA crosses ABOVE Slow EMA AND MACD is bullish
goldenBuy = emaCrossOver and macdLine > macdSignalLine
// Death Cross: Fast EMA crosses BELOW Slow EMA AND MACD is bearish
goldenSell = emaCrossUnder and macdLine < macdSignalLine

// ═══════════════════════════════════════════════════════════════════════════
// PIVOT DETECTION (MULTIPLE TIMEFRAMES)
// ═══════════════════════════════════════════════════════════════════════════

// Detector 1 (Fast)
pivotHigh1 = ta.pivothigh(high, pivotLength1, pivotLength1)
pivotLow1 = ta.pivotlow(low, pivotLength1, pivotLength1)

// Detector 2 (Medium)
pivotHigh2 = ta.pivothigh(high, pivotLength2, pivotLength2)
pivotLow2 = ta.pivotlow(low, pivotLength2, pivotLength2)

// Detector 3 (Slow)
pivotHigh3 = ta.pivothigh(high, pivotLength3, pivotLength3)
pivotLow3 = ta.pivotlow(low, pivotLength3, pivotLength3)

// ═══════════════════════════════════════════════════════════════════════════
// DIVERGENCE DETECTION (MULTIPLE DETECTORS, NON-REPAINTING)
// ═══════════════════════════════════════════════════════════════════════════

// Track last pivots for each detector
var float lastPivotHighPrice1 = na
var float lastPivotHighCVD1 = na
var int lastPivotHighBar1 = na

var float lastPivotLowPrice1 = na
var float lastPivotLowCVD1 = na
var int lastPivotLowBar1 = na

var float lastPivotHighPrice2 = na
var float lastPivotHighCVD2 = na
var int lastPivotHighBar2 = na

var float lastPivotLowPrice2 = na
var float lastPivotLowCVD2 = na
var int lastPivotLowBar2 = na

var float lastPivotHighPrice3 = na
var float lastPivotHighCVD3 = na
var int lastPivotHighBar3 = na

var float lastPivotLowPrice3 = na
var float lastPivotLowCVD3 = na
var int lastPivotLowBar3 = na

// Track divergence state across bars (persistent until trade or opposite divergence)
var bool hasBearishDivergence = false
var bool hasBullishDivergence = false

// Detector 1 - Bearish Divergence
if enableDivergence1 and not na(pivotHigh1)
    currentPivotPrice = high[pivotLength1]
    currentPivotCVD = cvd[pivotLength1]
    currentPivotBar = bar_index - pivotLength1
    
    if not na(lastPivotHighPrice1)
        // Classic: Price higher high + CVD lower high
        if showClassicDiv and showClassicBearish and currentPivotPrice > lastPivotHighPrice1 and currentPivotCVD < lastPivotHighCVD1
            hasBearishDivergence := true
            hasBullishDivergence := false
            if showDivergenceLabels
                label.new(currentPivotBar, currentPivotPrice, classicBearLabel + " (1)", xloc=xloc.bar_index, style=label.style_label_down, color=classicBearColor, textcolor=color.white, size=size.small, yloc=yloc.abovebar)
            if showDivergenceLines
                line.new(lastPivotHighBar1, lastPivotHighPrice1, currentPivotBar, currentPivotPrice, xloc=xloc.bar_index, color=classicBearColor, style=getLineStyle(classicLineStyle), width=classicLineWidth)
        // Absorption: Price new high but CVD doesn't
        if showAbsorptionDiv and showAbsorptionBearish and currentPivotPrice > lastPivotHighPrice1 and currentPivotCVD <= lastPivotHighCVD1
            hasBearishDivergence := true
            hasBullishDivergence := false
            if showDivergenceLabels
                label.new(currentPivotBar, currentPivotPrice, absorptionBearLabel + " (1)", xloc=xloc.bar_index, style=label.style_label_down, color=absorptionBearColor, textcolor=color.white, size=size.small, yloc=yloc.abovebar)
            if showDivergenceLines
                line.new(lastPivotHighBar1, lastPivotHighPrice1, currentPivotBar, currentPivotPrice, xloc=xloc.bar_index, color=absorptionBearColor, style=getLineStyle(absorptionLineStyle), width=absorptionLineWidth)
        // Exhaustion: CVD new high but price doesn't (buyers exhausted = bearish)
        if showExhaustionDiv and showExhaustionBearish and currentPivotCVD > lastPivotHighCVD1 and currentPivotPrice <= lastPivotHighPrice1
            hasBearishDivergence := true
            hasBullishDivergence := false
            if showDivergenceLabels
                label.new(currentPivotBar, currentPivotPrice, exhaustionBearLabel + " (1)", xloc=xloc.bar_index, style=label.style_label_down, color=exhaustionBearColor, textcolor=color.white, size=size.small, yloc=yloc.abovebar)
            if showDivergenceLines
                line.new(lastPivotHighBar1, lastPivotHighPrice1, currentPivotBar, currentPivotPrice, xloc=xloc.bar_index, color=exhaustionBearColor, style=getLineStyle(exhaustionLineStyle), width=exhaustionLineWidth)
    
    lastPivotHighPrice1 := currentPivotPrice
    lastPivotHighCVD1 := currentPivotCVD
    lastPivotHighBar1 := currentPivotBar

// Detector 1 - Bullish Divergence
if enableDivergence1 and not na(pivotLow1)
    currentPivotPrice = low[pivotLength1]
    currentPivotCVD = cvd[pivotLength1]
    currentPivotBar = bar_index - pivotLength1
    
    if not na(lastPivotLowPrice1)
        // Classic: Price lower low + CVD higher low
        if showClassicDiv and showClassicBullish and currentPivotPrice < lastPivotLowPrice1 and currentPivotCVD > lastPivotLowCVD1
            hasBullishDivergence := true
            hasBearishDivergence := false
            if showDivergenceLabels
                label.new(currentPivotBar, currentPivotPrice, classicBullLabel + " (1)", xloc=xloc.bar_index, style=label.style_label_up, color=classicBullColor, textcolor=color.white, size=size.small, yloc=yloc.belowbar)
            if showDivergenceLines
                line.new(lastPivotLowBar1, lastPivotLowPrice1, currentPivotBar, currentPivotPrice, xloc=xloc.bar_index, color=classicBullColor, style=getLineStyle(classicLineStyle), width=classicLineWidth)
        // Absorption: Price new low but CVD doesn't
        if showAbsorptionDiv and showAbsorptionBullish and currentPivotPrice < lastPivotLowPrice1 and currentPivotCVD >= lastPivotLowCVD1
            hasBullishDivergence := true
            hasBearishDivergence := false
            if showDivergenceLabels
                label.new(currentPivotBar, currentPivotPrice, absorptionBullLabel + " (1)", xloc=xloc.bar_index, style=label.style_label_up, color=absorptionBullColor, textcolor=color.white, size=size.small, yloc=yloc.belowbar)
            if showDivergenceLines
                line.new(lastPivotLowBar1, lastPivotLowPrice1, currentPivotBar, currentPivotPrice, xloc=xloc.bar_index, color=absorptionBullColor, style=getLineStyle(absorptionLineStyle), width=absorptionLineWidth)
        // Exhaustion: CVD new low but price doesn't (sellers exhausted = bullish)
        if showExhaustionDiv and showExhaustionBullish and currentPivotCVD < lastPivotLowCVD1 and currentPivotPrice >= lastPivotLowPrice1
            hasBullishDivergence := true
            hasBearishDivergence := false
            if showDivergenceLabels
                label.new(currentPivotBar, currentPivotPrice, exhaustionBullLabel + " (1)", xloc=xloc.bar_index, style=label.style_label_up, color=exhaustionBullColor, textcolor=color.white, size=size.small, yloc=yloc.belowbar)
            if showDivergenceLines
                line.new(lastPivotLowBar1, lastPivotLowPrice1, currentPivotBar, currentPivotPrice, xloc=xloc.bar_index, color=exhaustionBullColor, style=getLineStyle(exhaustionLineStyle), width=exhaustionLineWidth)
    
    lastPivotLowPrice1 := currentPivotPrice
    lastPivotLowCVD1 := currentPivotCVD
    lastPivotLowBar1 := currentPivotBar

// Detector 2 - Bearish Divergence
if enableDivergence2 and not na(pivotHigh2)
    currentPivotPrice = high[pivotLength2]
    currentPivotCVD = cvd[pivotLength2]
    currentPivotBar = bar_index - pivotLength2
    
    if not na(lastPivotHighPrice2)
        if showClassicDiv and showClassicBearish and currentPivotPrice > lastPivotHighPrice2 and currentPivotCVD < lastPivotHighCVD2
            hasBearishDivergence := true
            hasBullishDivergence := false
            if showDivergenceLabels
                label.new(currentPivotBar, currentPivotPrice, classicBearLabel + " (2)", xloc=xloc.bar_index, style=label.style_label_down, color=classicBearColor, textcolor=color.white, size=size.small, yloc=yloc.abovebar)
            if showDivergenceLines
                line.new(lastPivotHighBar2, lastPivotHighPrice2, currentPivotBar, currentPivotPrice, xloc=xloc.bar_index, color=classicBearColor, style=getLineStyle(classicLineStyle), width=classicLineWidth)
    
    lastPivotHighPrice2 := currentPivotPrice
    lastPivotHighCVD2 := currentPivotCVD
    lastPivotHighBar2 := currentPivotBar

// Detector 2 - Bullish Divergence
if enableDivergence2 and not na(pivotLow2)
    currentPivotPrice = low[pivotLength2]
    currentPivotCVD = cvd[pivotLength2]
    currentPivotBar = bar_index - pivotLength2
    
    if not na(lastPivotLowPrice2)
        if showClassicDiv and showClassicBullish and currentPivotPrice < lastPivotLowPrice2 and currentPivotCVD > lastPivotLowCVD2
            hasBullishDivergence := true
            hasBearishDivergence := false
            if showDivergenceLabels
                label.new(currentPivotBar, currentPivotPrice, classicBullLabel + " (2)", xloc=xloc.bar_index, style=label.style_label_up, color=classicBullColor, textcolor=color.white, size=size.small, yloc=yloc.belowbar)
            if showDivergenceLines
                line.new(lastPivotLowBar2, lastPivotLowPrice2, currentPivotBar, currentPivotPrice, xloc=xloc.bar_index, color=classicBullColor, style=getLineStyle(classicLineStyle), width=classicLineWidth)
    
    lastPivotLowPrice2 := currentPivotPrice
    lastPivotLowCVD2 := currentPivotCVD
    lastPivotLowBar2 := currentPivotBar

// Detector 3 - Bearish Divergence
if enableDivergence3 and not na(pivotHigh3)
    currentPivotPrice = high[pivotLength3]
    currentPivotCVD = cvd[pivotLength3]
    currentPivotBar = bar_index - pivotLength3
    
    if not na(lastPivotHighPrice3)
        if showClassicDiv and showClassicBearish and currentPivotPrice > lastPivotHighPrice3 and currentPivotCVD < lastPivotHighCVD3
            hasBearishDivergence := true
            hasBullishDivergence := false
            if showDivergenceLabels
                label.new(currentPivotBar, currentPivotPrice, classicBearLabel + " (3)", xloc=xloc.bar_index, style=label.style_label_down, color=classicBearColor, textcolor=color.white, size=size.small, yloc=yloc.abovebar)
            if showDivergenceLines
                line.new(lastPivotHighBar3, lastPivotHighPrice3, currentPivotBar, currentPivotPrice, xloc=xloc.bar_index, color=classicBearColor, style=getLineStyle(classicLineStyle), width=classicLineWidth)
    
    lastPivotHighPrice3 := currentPivotPrice
    lastPivotHighCVD3 := currentPivotCVD
    lastPivotHighBar3 := currentPivotBar

// Detector 3 - Bullish Divergence
if enableDivergence3 and not na(pivotLow3)
    currentPivotPrice = low[pivotLength3]
    currentPivotCVD = cvd[pivotLength3]
    currentPivotBar = bar_index - pivotLength3
    
    if not na(lastPivotLowPrice3)
        if showClassicDiv and showClassicBullish and currentPivotPrice < lastPivotLowPrice3 and currentPivotCVD > lastPivotLowCVD3
            hasBullishDivergence := true
            hasBearishDivergence := false
            if showDivergenceLabels
                label.new(currentPivotBar, currentPivotPrice, classicBullLabel + " (3)", xloc=xloc.bar_index, style=label.style_label_up, color=classicBullColor, textcolor=color.white, size=size.small, yloc=yloc.belowbar)
            if showDivergenceLines
                line.new(lastPivotLowBar3, lastPivotLowPrice3, currentPivotBar, currentPivotPrice, xloc=xloc.bar_index, color=classicBullColor, style=getLineStyle(classicLineStyle), width=classicLineWidth)
    
    lastPivotLowPrice3 := currentPivotPrice
    lastPivotLowCVD3 := currentPivotCVD
    lastPivotLowBar3 := currentPivotBar

// ═══════════════════════════════════════════════════════════════════════════
// LIVE DIVERGENCE DETECTION (UNCONFIRMED - REAL-TIME)
// ═══════════════════════════════════════════════════════════════════════════

// Track live divergence lines/labels for deletion each bar (only truly live divergences persist)
var line liveBullLine = na
var line liveBearLine = na
var label liveBullLabel = na
var label liveBearLabel = na

if enableLiveDivergence
    // Delete previous bar's live divergences (they'll be recreated if still valid)
    // This ensures only current "Live" divergences show, not historical ones
    if not na(liveBullLine)
        line.delete(liveBullLine)
        liveBullLine := na
    if not na(liveBearLine)
        line.delete(liveBearLine)
        liveBearLine := na
    if not na(liveBullLabel)
        label.delete(liveBullLabel)
        liveBullLabel := na
    if not na(liveBearLabel)
        label.delete(liveBearLabel)
        liveBearLabel := na
    
    // Live Bearish Divergence Detection
    // Enhanced: Look for CVD extremes vs price extremes over lookback period
    // Find the highest CVD and highest price in the lookback period (excluding current bar)
    float lookbackHighPrice = ta.highest(high, liveDivLookback)[1]
    float lookbackHighCVD = ta.highest(cvd, liveDivLookback)[1]
    int lookbackHighPriceBar = na
    int lookbackHighCVDBar = na
    
    // Find the bar where the lookback high price occurred
    for i = 1 to liveDivLookback
        if high[i] == lookbackHighPrice and na(lookbackHighPriceBar)
            lookbackHighPriceBar := bar_index - i
            break
    
    // Find the bar where the lookback high CVD occurred  
    for i = 1 to liveDivLookback
        if cvd[i] == lookbackHighCVD and na(lookbackHighCVDBar)
            lookbackHighCVDBar := bar_index - i
            break
    
    // Check for live bearish divergence using lookback extremes
    if not na(lookbackHighPrice) and not na(lookbackHighCVD) and not na(lookbackHighPriceBar)
        // Classic: Current high > lookback high but CVD lower than lookback high CVD
        if showClassicDiv and showClassicBearish and high > lookbackHighPrice and cvd < lookbackHighCVD
            if showDivergenceLabels
                // Create live label (will be deleted next bar if not still valid)
                liveBearLabel := label.new(bar_index, high, "Live " + classicBearLabel, xloc=xloc.bar_index, style=label.style_label_down, color=liveDivBearColor, textcolor=color.white, size=size.tiny, yloc=yloc.abovebar)
            if showDivergenceLines
                // Create live line (will be deleted next bar if not still valid)
                liveBearLine := line.new(lookbackHighPriceBar, lookbackHighPrice, bar_index, high, xloc=xloc.bar_index, color=liveDivBearColor, style=getLineStyle(liveDivLineStyle), width=liveDivLineWidth)
        // Absorption: Current high > lookback but CVD not higher
        else if showAbsorptionDiv and showAbsorptionBearish and high > lookbackHighPrice and cvd <= lookbackHighCVD
            if showDivergenceLabels
                liveBearLabel := label.new(bar_index, high, "Live " + absorptionBearLabel, xloc=xloc.bar_index, style=label.style_label_down, color=liveDivBearColor, textcolor=color.white, size=size.tiny, yloc=yloc.abovebar)
            if showDivergenceLines
                liveBearLine := line.new(lookbackHighPriceBar, lookbackHighPrice, bar_index, high, xloc=xloc.bar_index, color=liveDivBearColor, style=getLineStyle(liveDivLineStyle), width=liveDivLineWidth)
        // Exhaustion: CVD higher but price not (CVD makes new high, price doesn't)
        else if showExhaustionDiv and showExhaustionBearish and cvd > lookbackHighCVD and high <= lookbackHighPrice
            if showDivergenceLabels
                liveBearLabel := label.new(bar_index, high, "Live " + exhaustionBearLabel, xloc=xloc.bar_index, style=label.style_label_down, color=liveDivBearColor, textcolor=color.white, size=size.tiny, yloc=yloc.abovebar)
            if showDivergenceLines
                // For exhaustion, connect from CVD high bar to current price
                liveBearLine := line.new(lookbackHighCVDBar, high[bar_index - lookbackHighCVDBar], bar_index, high, xloc=xloc.bar_index, color=liveDivBearColor, style=getLineStyle(liveDivLineStyle), width=liveDivLineWidth)
    
    // Live Bullish Divergence Detection
    // Enhanced: Look for CVD extremes vs price extremes over lookback period
    // Find the lowest CVD and lowest price in the lookback period (excluding current bar)
    float lookbackLowPrice = ta.lowest(low, liveDivLookback)[1]
    float lookbackLowCVD = ta.lowest(cvd, liveDivLookback)[1]
    int lookbackLowPriceBar = na
    int lookbackLowCVDBar = na
    
    // Find the bar where the lookback low price occurred
    for i = 1 to liveDivLookback
        if low[i] == lookbackLowPrice and na(lookbackLowPriceBar)
            lookbackLowPriceBar := bar_index - i
            break
    
    // Find the bar where the lookback low CVD occurred
    for i = 1 to liveDivLookback
        if cvd[i] == lookbackLowCVD and na(lookbackLowCVDBar)
            lookbackLowCVDBar := bar_index - i
            break
    
    // Check for live bullish divergence using lookback extremes
    if not na(lookbackLowPrice) and not na(lookbackLowCVD) and not na(lookbackLowPriceBar)
        // Classic: Current low < lookback low but CVD higher than lookback low CVD
        if showClassicDiv and showClassicBullish and low < lookbackLowPrice and cvd > lookbackLowCVD
            if showDivergenceLabels
                // Create live label (will be deleted next bar if not still valid)
                liveBullLabel := label.new(bar_index, low, "Live " + classicBullLabel, xloc=xloc.bar_index, style=label.style_label_up, color=liveDivBullColor, textcolor=color.white, size=size.tiny, yloc=yloc.belowbar)
            if showDivergenceLines
                // Create live line (will be deleted next bar if not still valid)
                liveBullLine := line.new(lookbackLowPriceBar, lookbackLowPrice, bar_index, low, xloc=xloc.bar_index, color=liveDivBullColor, style=getLineStyle(liveDivLineStyle), width=liveDivLineWidth)
        // Absorption: Current low < lookback but CVD not lower
        else if showAbsorptionDiv and showAbsorptionBullish and low < lookbackLowPrice and cvd >= lookbackLowCVD
            if showDivergenceLabels
                liveBullLabel := label.new(bar_index, low, "Live " + absorptionBullLabel, xloc=xloc.bar_index, style=label.style_label_up, color=liveDivBullColor, textcolor=color.white, size=size.tiny, yloc=yloc.belowbar)
            if showDivergenceLines
                liveBullLine := line.new(lookbackLowPriceBar, lookbackLowPrice, bar_index, low, xloc=xloc.bar_index, color=liveDivBullColor, style=getLineStyle(liveDivLineStyle), width=liveDivLineWidth)
        // Exhaustion: CVD lower but price not (CVD makes new low, price doesn't)
        else if showExhaustionDiv and showExhaustionBullish and cvd < lookbackLowCVD and low >= lookbackLowPrice
            if showDivergenceLabels
                liveBullLabel := label.new(bar_index, low, "Live " + exhaustionBullLabel, xloc=xloc.bar_index, style=label.style_label_up, color=liveDivBullColor, textcolor=color.white, size=size.tiny, yloc=yloc.belowbar)
            if showDivergenceLines
                // For exhaustion, connect from CVD low bar to current price
                liveBullLine := line.new(lookbackLowCVDBar, low[bar_index - lookbackLowCVDBar], bar_index, low, xloc=xloc.bar_index, color=liveDivBullColor, style=getLineStyle(liveDivLineStyle), width=liveDivLineWidth)

// ═══════════════════════════════════════════════════════════════════════════
// CANDLE PATTERN DETECTION
// ═══════════════════════════════════════════════════════════════════════════

// Bullish Engulfing - current candle is bullish and body engulfs previous candle's body
bullishEngulfing = close > open and close[1] < open[1] and close >= open[1] and open <= close[1]

// Bearish Engulfing - current candle is bearish and body engulfs previous candle's body  
bearishEngulfing = close < open and close[1] > open[1] and close <= open[1] and open >= close[1]

// Pin Bar (High/Low Test) Detection
// Bullish Pin Bar - long lower wick, small body, closes near high (tests low and rejects)
bodySize = math.abs(close - open)
upperWick = high - math.max(close, open)
lowerWick = math.min(close, open) - low
totalRange = high - low

bullishPinBar = totalRange > 0 and lowerWick > (totalRange * 0.6) and bodySize < (totalRange * 0.3) and close > open and upperWick < (totalRange * 0.3)

// Bearish Pin Bar - long upper wick, small body, closes near low (tests high and rejects)
bearishPinBar = totalRange > 0 and upperWick > (totalRange * 0.6) and bodySize < (totalRange * 0.3) and close < open and lowerWick < (totalRange * 0.3)

// Bullish confirmation candle based on mode
bullishConfirmation = switch candleMode
    "Engulfing Only" => bullishEngulfing
    "Pin Bar Only" => bullishPinBar
    "Both" => (useBullishEngulfing and bullishEngulfing) or (useBullishPinBar and bullishPinBar)
    => false

// Bearish confirmation candle based on mode
bearishConfirmation = switch candleMode
    "Engulfing Only" => bearishEngulfing
    "Pin Bar Only" => bearishPinBar
    "Both" => (useBearishEngulfing and bearishEngulfing) or (useBearishPinBar and bearishPinBar)
    => false

// ═══════════════════════════════════════════════════════════════════════════
// ASIA SESSION SWEEP DETECTION
// ═══════════════════════════════════════════════════════════════════════════

var bool asiaLowSwept = false
var bool asiaHighSwept = false

// Sweep of Asia Low: price goes below and closes back above
if not na(asiaLow)
    if low < asiaLow and close > asiaLow
        asiaLowSwept := true

// Sweep of Asia High: price goes above and closes back below
if not na(asiaHigh)
    if high > asiaHigh and close < asiaHigh
        asiaHighSwept := true

// Reset sweep flags at start of new Asia session
if asiaSessionStarted
    asiaLowSwept := false
    asiaHighSwept := false

// ═══════════════════════════════════════════════════════════════════════════
// ENTRY LOGIC
// ═══════════════════════════════════════════════════════════════════════════

// Check if trading is allowed based on day filters and kill zone windows
tradingAllowed = isDayEnabled()
inKillZone = isLondonKZWindow or isNYKZWindow or isInAdditionalSession

// Modular Full Entry Signal (Signal 1)
signal1LongConditions = useSignal1
signal1ShortConditions = useSignal1

if signal1RequireLiqSweep
    signal1LongConditions := signal1LongConditions and asiaLowSwept
    signal1ShortConditions := signal1ShortConditions and asiaHighSwept

if signal1RequireDivergence
    signal1LongConditions := signal1LongConditions and hasBullishDivergence
    signal1ShortConditions := signal1ShortConditions and hasBearishDivergence

if signal1RequireEngulfing
    signal1LongConditions := signal1LongConditions and bullishConfirmation
    signal1ShortConditions := signal1ShortConditions and bearishConfirmation

if signal1RequireKillZone
    signal1LongConditions := signal1LongConditions and inKillZone
    signal1ShortConditions := signal1ShortConditions and inKillZone

if signal1RequireDayFilter
    signal1LongConditions := signal1LongConditions and tradingAllowed
    signal1ShortConditions := signal1ShortConditions and tradingAllowed

signal1Long = signal1LongConditions
signal1Short = signal1ShortConditions

// Modular Simple Entry Signal (Signal 2)
signal2LongConditions = useSignal2
signal2ShortConditions = useSignal2

if signal2RequireDivergence
    signal2LongConditions := signal2LongConditions and hasBullishDivergence
    signal2ShortConditions := signal2ShortConditions and hasBearishDivergence

if signal2RequireEngulfing
    signal2LongConditions := signal2LongConditions and bullishConfirmation
    signal2ShortConditions := signal2ShortConditions and bearishConfirmation

if signal2RequireKillZone
    signal2LongConditions := signal2LongConditions and inKillZone
    signal2ShortConditions := signal2ShortConditions and inKillZone

if signal2RequireDayFilter
    signal2LongConditions := signal2LongConditions and tradingAllowed
    signal2ShortConditions := signal2ShortConditions and tradingAllowed

signal2Long = signal2LongConditions
signal2Short = signal2ShortConditions

// Modular MACD + EMA Entry Signal (Signal 3)
signal3LongConditions = useSignal3 and enableMacdEma and goldenBuy
signal3ShortConditions = useSignal3 and enableMacdEma and goldenSell

if signal3RequireKillZone
    signal3LongConditions := signal3LongConditions and inKillZone
    signal3ShortConditions := signal3ShortConditions and inKillZone

if signal3RequireDayFilter
    signal3LongConditions := signal3LongConditions and tradingAllowed
    signal3ShortConditions := signal3ShortConditions and tradingAllowed

signal3Long = signal3LongConditions
signal3Short = signal3ShortConditions

// Combined entry signals
longEntry = signal1Long or signal2Long or signal3Long
shortEntry = signal1Short or signal2Short or signal3Short

// Debug: Show when Signal 2 entries are triggered
plotshape(signal2Long, "Signal 2 Long", shape.triangleup, location.belowbar, color.new(color.lime, 0), size=size.tiny)
plotshape(signal2Short, "Signal 2 Short", shape.triangledown, location.abovebar, color.new(color.red, 0), size=size.tiny)

// Debug: Show when Signal 3 (MACD + EMA) entries are triggered
plotshape(signal3Long and showMacdEmaSignals, "MACD+EMA Buy", shape.labelup, location.belowbar, color.yellow, text="B", textcolor=color.black, size=size.small)
plotshape(signal3Short and showMacdEmaSignals, "MACD+EMA Sell", shape.labeldown, location.abovebar, color.orange, text="S", textcolor=color.black, size=size.small)

// ═══════════════════════════════════════════════════════════════════════════
// TRADE MANAGEMENT
// ═══════════════════════════════════════════════════════════════════════════

var float entryPrice = na
var float stopLossPrice = na
var float tp1Price = na
var float tp2Price = na
var float tp3Price = na
var bool movedToBreakeven = false

// Track trade state
var bool inTrade = false

// Trade lines
var line entryLine = na
var line slLine = na
var line tp1Line = na
var line tp2Line = na
var line tp3Line = na
var int tradeStartBar = na

// Long Entry
if longEntry and strategy.position_size == 0
    entryPrice := close
    
    // Calculate stop loss using pips
    stopLossPrice := entryPrice - pipsToPrice(stopLossPips)
    
    // Calculate take profit levels
    tp1Price := entryPrice + pipsToPrice(tp1Pips)
    tp2Price := entryPrice + pipsToPrice(tp2Pips)
    tp3Price := entryPrice + pipsToPrice(tp3Pips)
    
    strategy.entry("Long", strategy.long)
    inTrade := true
    movedToBreakeven := false
    tradeStartBar := bar_index
    
    // Draw trade lines
    if showTradeLines
        // Delete old lines if they exist
        if not na(entryLine)
            line.delete(entryLine)
        if not na(slLine)
            line.delete(slLine)
        if not na(tp1Line)
            line.delete(tp1Line)
        if not na(tp2Line)
            line.delete(tp2Line)
        if not na(tp3Line)
            line.delete(tp3Line)
        
        // Create new lines with custom width
        entryLine := line.new(bar_index, entryPrice, bar_index, entryPrice, color=color.white, style=line.style_solid, width=tradeLineWidth)
        slLine := line.new(bar_index, stopLossPrice, bar_index, stopLossPrice, color=color.red, style=line.style_dashed, width=tradeLineWidth)
        tp1Line := line.new(bar_index, tp1Price, bar_index, tp1Price, color=color.green, style=line.style_dashed, width=tradeLineWidth)
        tp2Line := line.new(bar_index, tp2Price, bar_index, tp2Price, color=color.green, style=line.style_dashed, width=tradeLineWidth)
        tp3Line := line.new(bar_index, tp3Price, bar_index, tp3Price, color=color.green, style=line.style_dashed, width=tradeLineWidth)
        
        // Create labels
        label.new(bar_index, entryPrice, "Entry", style=label.style_label_left, color=color.white, textcolor=color.black, size=size.tiny)
        label.new(bar_index, stopLossPrice, "SL", style=label.style_label_left, color=color.red, textcolor=color.white, size=size.tiny)
        label.new(bar_index, tp1Price, "TP1", style=label.style_label_left, color=color.green, textcolor=color.white, size=size.tiny)
        label.new(bar_index, tp2Price, "TP2", style=label.style_label_left, color=color.green, textcolor=color.white, size=size.tiny)
        label.new(bar_index, tp3Price, "TP3", style=label.style_label_left, color=color.green, textcolor=color.white, size=size.tiny)
    
    // Reset divergence flags after entry
    hasBullishDivergence := false
    asiaLowSwept := false

// Short Entry
if shortEntry and strategy.position_size == 0
    entryPrice := close
    
    // Calculate stop loss using pips
    stopLossPrice := entryPrice + pipsToPrice(stopLossPips)
    
    // Calculate take profit levels
    tp1Price := entryPrice - pipsToPrice(tp1Pips)
    tp2Price := entryPrice - pipsToPrice(tp2Pips)
    tp3Price := entryPrice - pipsToPrice(tp3Pips)
    
    strategy.entry("Short", strategy.short)
    inTrade := true
    movedToBreakeven := false
    tradeStartBar := bar_index
    
    // Draw trade lines
    if showTradeLines
        // Delete old lines if they exist
        if not na(entryLine)
            line.delete(entryLine)
        if not na(slLine)
            line.delete(slLine)
        if not na(tp1Line)
            line.delete(tp1Line)
        if not na(tp2Line)
            line.delete(tp2Line)
        if not na(tp3Line)
            line.delete(tp3Line)
        
        // Create new lines with custom width
        entryLine := line.new(bar_index, entryPrice, bar_index, entryPrice, color=color.white, style=line.style_solid, width=tradeLineWidth)
        slLine := line.new(bar_index, stopLossPrice, bar_index, stopLossPrice, color=color.red, style=line.style_dashed, width=tradeLineWidth)
        tp1Line := line.new(bar_index, tp1Price, bar_index, tp1Price, color=color.green, style=line.style_dashed, width=tradeLineWidth)
        tp2Line := line.new(bar_index, tp2Price, bar_index, tp2Price, color=color.green, style=line.style_dashed, width=tradeLineWidth)
        tp3Line := line.new(bar_index, tp3Price, bar_index, tp3Price, color=color.green, style=line.style_dashed, width=tradeLineWidth)
        
        // Create labels
        label.new(bar_index, entryPrice, "Entry", style=label.style_label_left, color=color.white, textcolor=color.black, size=size.tiny)
        label.new(bar_index, stopLossPrice, "SL", style=label.style_label_left, color=color.red, textcolor=color.white, size=size.tiny)
        label.new(bar_index, tp1Price, "TP1", style=label.style_label_left, color=color.green, textcolor=color.white, size=size.tiny)
        label.new(bar_index, tp2Price, "TP2", style=label.style_label_left, color=color.green, textcolor=color.white, size=size.tiny)
        label.new(bar_index, tp3Price, "TP3", style=label.style_label_left, color=color.green, textcolor=color.white, size=size.tiny)
    
    // Reset divergence flags after entry
    hasBearishDivergence := false
    asiaHighSwept := false

// Extend trade lines each bar (up to max hours)
if showTradeLines and not na(entryLine) and strategy.position_size != 0
    maxBars = calcMaxBars(maxLineHours)
    if bar_index - tradeStartBar < maxBars
        line.set_x2(entryLine, bar_index)
        line.set_x2(slLine, bar_index)
        line.set_x2(tp1Line, bar_index)
        line.set_x2(tp2Line, bar_index)
        line.set_x2(tp3Line, bar_index)

// ═══════════════════════════════════════════════════════════════════════════
// EXIT LOGIC
// ═══════════════════════════════════════════════════════════════════════════

// Track position state
if strategy.position_size == 0
    inTrade := false

// Current stop loss price (updated for breakeven)
var float currentStopLoss = na

if strategy.position_size > 0  // Long position
    // Update current stop loss on first bar of position
    if inTrade and na(currentStopLoss)
        currentStopLoss := stopLossPrice
    
    // Move stop loss to breakeven after TP1
    if moveToBreakevenAfterTP1 and not movedToBreakeven and not na(entryPrice)
        if close >= tp1Price
            currentStopLoss := entryPrice
            movedToBreakeven := true
    
    // Move stop loss to breakeven after TP2 (if not already moved)
    if moveToBreakevenAfterTP2 and enableTP2 and not movedToBreakeven and not na(entryPrice)
        if close >= tp2Price
            currentStopLoss := entryPrice
            movedToBreakeven := true
    
    // Calculate partial exit quantities based on strategy equity
    posSize = strategy.position_size
    tp1Qty = posSize * tp1Percent / 100
    remainingAfterTP1 = posSize - tp1Qty
    tp2Qty = remainingAfterTP1 * tp2ExitPercent / 100
    
    // Place exit orders based on what's enabled
    strategy.exit("Exit_TP1", "Long", stop=currentStopLoss, limit=tp1Price, qty=tp1Qty)
    
    if enableTP2
        strategy.exit("Exit_TP2", "Long", stop=currentStopLoss, limit=tp2Price, qty=tp2Qty)
    
    if enableTP3
        strategy.exit("Exit_TP3", "Long", stop=currentStopLoss, limit=tp3Price)
    else if not enableTP2
        // If TP3 disabled and TP2 disabled, exit remaining at TP1
        strategy.exit("Exit_Remaining", "Long", stop=currentStopLoss)
    else
        // If TP3 disabled but TP2 enabled, exit remaining at TP2
        strategy.exit("Exit_Remaining", "Long", stop=currentStopLoss)

if strategy.position_size < 0  // Short position
    // Update current stop loss on first bar of position
    if inTrade and na(currentStopLoss)
        currentStopLoss := stopLossPrice
    
    // Move stop loss to breakeven after TP1
    if moveToBreakevenAfterTP1 and not movedToBreakeven and not na(entryPrice)
        if close <= tp1Price
            currentStopLoss := entryPrice
            movedToBreakeven := true
    
    // Move stop loss to breakeven after TP2 (if not already moved)
    if moveToBreakevenAfterTP2 and enableTP2 and not movedToBreakeven and not na(entryPrice)
        if close <= tp2Price
            currentStopLoss := entryPrice
            movedToBreakeven := true
    
    // Calculate partial exit quantities based on strategy equity
    posSize = math.abs(strategy.position_size)
    tp1Qty = posSize * tp1Percent / 100
    remainingAfterTP1 = posSize - tp1Qty
    tp2Qty = remainingAfterTP1 * tp2ExitPercent / 100
    
    // Place exit orders based on what's enabled
    strategy.exit("Exit_TP1", "Short", stop=currentStopLoss, limit=tp1Price, qty=tp1Qty)
    
    if enableTP2
        strategy.exit("Exit_TP2", "Short", stop=currentStopLoss, limit=tp2Price, qty=tp2Qty)
    
    if enableTP3
        strategy.exit("Exit_TP3", "Short", stop=currentStopLoss, limit=tp3Price)
    else if not enableTP2
        // If TP3 disabled and TP2 disabled, exit remaining at TP1
        strategy.exit("Exit_Remaining", "Short", stop=currentStopLoss)
    else
        // If TP3 disabled but TP2 enabled, exit remaining at TP2
        strategy.exit("Exit_Remaining", "Short", stop=currentStopLoss)

// Reset currentStopLoss when position closes
if strategy.position_size == 0 and not na(currentStopLoss)
    currentStopLoss := na

// Delete trade lines when position closes or max time exceeded
if showTradeLines and not na(entryLine)
    maxBars = calcMaxBars(maxLineHours)
    if strategy.position_size == 0 or (bar_index - tradeStartBar >= maxBars)
        line.delete(entryLine)
        line.delete(slLine)
        line.delete(tp1Line)
        line.delete(tp2Line)
        line.delete(tp3Line)
        entryLine := na
        slLine := na
        tp1Line := na
        tp2Line := na
        tp3Line := na

// ═══════════════════════════════════════════════════════════════════════════
// VISUAL INDICATORS
// ═══════════════════════════════════════════════════════════════════════════

// ═══════════════════════════════════════════════════════════════════════════
// MACD + EMA VISUAL INDICATORS
// ═══════════════════════════════════════════════════════════════════════════

// Plot EMA lines if enabled
emaMomPlot = plot(enableMacdEma and showEmaLines ? emaMom : na, title="EMA Momentum", color=emaMomColor, linewidth=2)
emaFastPlot = plot(enableMacdEma and showEmaLines ? emaFast : na, title="EMA Fast", color=emaFastColor, linewidth=2)
emaSlowPlot = plot(enableMacdEma and showEmaLines ? emaSlow : na, title="EMA Slow", color=emaSlowColor, linewidth=2)
plot(enableMacdEma and showEmaLines ? emaDirection : na, title="EMA Direction", color=emaDirColor, linewidth=2)

// Plot EMA Cross markers - Green for Golden Cross (bullish), Red for Death Cross (bearish)
plot(enableMacdEma and showMacdEmaCross and emaCrossOver ? emaFast : na, title="Golden Cross", style=plot.style_cross, color=color.lime, linewidth=3)
plot(enableMacdEma and showMacdEmaCross and emaCrossUnder ? emaFast : na, title="Death Cross", style=plot.style_cross, color=color.red, linewidth=3)

// EMA Cloud fill
cloudColor = emaFast > emaSlow ? emaCloudBullColor : emaCloudBearColor
fill(emaFastPlot, emaSlowPlot, color=enableMacdEma and showEmaCloud ? cloudColor : na, title="EMA Cloud")

// Plot entry signals
plotshape(longEntry, "Long Entry", shape.triangleup, location.belowbar, color.green, size=size.small)
plotshape(shortEntry, "Short Entry", shape.triangledown, location.abovebar, color.red, size=size.small)

// Entry Candle Indicators
// Determine if we should show candles based on time filter
inCandleTimeWindow = if candleTimeFilter == "All Times"
    true
else if candleTimeFilter == "Kill Zones Only"
    inKillZone
else if candleTimeFilter == "Custom Time Range"
    inSession(candleCustomSession, sessionTimezone)
else
    true

// Show engulfing candles and pin bars with editable text labels
showEngulfingNow = showEngulfingIndicator and inCandleTimeWindow

// Entry candle indicators - plotshape for Style tab customization (shape, color, size)
// Text labels are separate and use custom text from Inputs tab
plotshape(showEngulfingNow and bullishEngulfing, "Bullish Engulfing", location=location.belowbar, size=size.small)
if showEngulfingNow and bullishEngulfing
    label.new(bar_index, low - (high - low) * 0.002, bullishEngulfingText, style=label.style_none, textcolor=color.green, size=size.small, xloc=xloc.bar_index)

plotshape(showEngulfingNow and bearishEngulfing, "Bearish Engulfing", location=location.abovebar, size=size.small)
if showEngulfingNow and bearishEngulfing
    label.new(bar_index, high + (high - low) * 0.002, bearishEngulfingText, style=label.style_none, textcolor=color.red, size=size.small, xloc=xloc.bar_index)

showPinBarNow = showPinBarIndicator and inCandleTimeWindow

// Pin bar indicators - plotshape for Style tab customization (shape, color, size)
// Text labels are separate and use custom text from Inputs tab
plotshape(showPinBarNow and bullishPinBar, "Bullish Pin Bar", location=location.belowbar, size=size.small)
if showPinBarNow and bullishPinBar
    label.new(bar_index, low - (high - low) * 0.002, bullishPinBarText, style=label.style_none, textcolor=color.blue, size=size.small, xloc=xloc.bar_index)

plotshape(showPinBarNow and bearishPinBar, "Bearish Pin Bar", location=location.abovebar, size=size.small)
if showPinBarNow and bearishPinBar
    label.new(bar_index, high + (high - low) * 0.002, bearishPinBarText, style=label.style_none, textcolor=color.orange, size=size.small, xloc=xloc.bar_index)

// Background color for Kill Zone windows
bgcolor(isLondonKZWindow ? color.new(color.orange, 95) : na, title="London KZ Background")
bgcolor(isNYKZWindow ? color.new(color.green, 95) : na, title="NY KZ Background")

// Background color for Asia session (for reference)
bgcolor(isAsiaSession ? color.new(color.blue, 95) : na, title="Asia Session Background")

// ═══════════════════════════════════════════════════════════════════════════
// CVD INDICATOR PANE
// ═══════════════════════════════════════════════════════════════════════════

if showCVDPane
    // Plot CVD as candlestick
    cvdColor = lastVolume >= openVolume ? color.teal : color.red
    // Note: Since we're in a strategy (overlay=true), we cannot use plotcandle for a separate pane
    // Instead, we'll plot CVD values and show divergence connections on price chart
    
// Note: Divergence lines are now drawn directly in the divergence detection logic above
// and persist on historical data without deletion

// ═══════════════════════════════════════════════════════════════════════════
// MACD + EMA ALERTS
// ═══════════════════════════════════════════════════════════════════════════

// Alert conditions for MACD + EMA signals
alertcondition(goldenBuy, title="MACD+EMA Buy Signal", message="MACD+EMA Buy Signal (Golden Cross) for {{ticker}} : {{exchange}}")
alertcondition(goldenSell, title="MACD+EMA Sell Signal", message="MACD+EMA Sell Signal (Death Cross) for {{ticker}} : {{exchange}}")
alertcondition(signal3Long, title="Signal 3 Long Entry", message="MACD+EMA Long Entry Signal for {{ticker}} : {{exchange}}")
alertcondition(signal3Short, title="Signal 3 Short Entry", message="MACD+EMA Short Entry Signal for {{ticker}} : {{exchange}}")
